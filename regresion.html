<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regresión Lineal: Predictor de Éxito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; color: #1f2937; }
        #dataChart { background-color: #ffffff; border: 2px solid #e5e7eb; cursor: crosshair; }
        .data-input { width: 100%; height: 2.5rem; background-color: #e0f2f7; border-radius: 0.5rem; cursor: pointer; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex items-center justify-center">

    <div id="appContainer" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10 border border-gray-100">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-sky-700">Data Mining: Regresión Lineal</h1>
            <p class="text-gray-500 mt-2">Versión Web Estática - Estudio vs. Éxito</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="p-4 bg-sky-50 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-sky-600">1. Tus Datos</h2>
                <form id="dataForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tu Nombre:</label>
                        <input type="text" id="userName" required placeholder="Tu nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Horas de Estudio (0-40):</label>
                        <input type="range" id="studyHours" min="0" max="40" step="1" value="20" class="data-input bg-sky-200" oninput="document.getElementById('studyValue').innerText = this.value;">
                        <span id="studyValue" class="text-lg font-semibold text-sky-700">20</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nivel de Éxito REAL (0-10):</label>
                        <input type="range" id="successScore" min="0" max="10" step="0.5" value="5.0" class="data-input bg-sky-400" oninput="document.getElementById('successValue').innerText = this.value;">
                        <span id="successValue" class="text-lg font-semibold text-sky-700">5.0</span>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full py-3 px-4 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 shadow-md transition">Entrenar Modelo</button>
                </form>
                <div id="resultBox" class="mt-6 p-4 bg-white border border-sky-300 rounded-lg hidden">
                    <h3 class="font-bold text-sky-800">Resultado:</h3>
                    <p id="predictionResult" class="text-2xl mt-1 font-extrabold"></p>
                </div>
                <p id="loadingMessage" class="mt-4 text-center text-sky-600 text-sm">Conectando con base de datos...</p>
            </div>

            <div class="p-4 bg-white rounded-lg border border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-sky-600">2. Gráfico en Tiempo Real</h2>
                <canvas id="dataChart" width="400" height="400" class="w-full h-auto rounded-lg"></canvas>
                <p id="lineEquation" class="text-center text-sm mt-2 text-gray-500 font-mono"></p>
            </div>
        </div>

        <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-bold mb-4 text-sky-600">3. Predicción (Prueba el modelo)</h2>
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-grow w-full">
                    <label class="block text-sm font-medium text-gray-700">Horas (X) para predecir:</label>
                    <input type="range" id="predictHours" min="0" max="40" step="1" value="20" class="data-input bg-green-200" oninput="document.getElementById('predictValueDisplay').innerText = this.value;">
                    <span id="predictValueDisplay" class="text-lg font-semibold text-sky-700">20</span>
                </div>
                <button id="predictBtn" class="py-3 px-6 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-md">Predecir</button>
            </div>
            <p id="predictionText" class="mt-4 text-2xl font-extrabold text-green-700 text-center"></p>
        </div>
    </div>

    <!-- SDKs de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==================================================================
        // CONFIGURACIÓN DE FIREBASE
        // ==================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyDioLs_q_WyFhPmXdwuqYs9fxMRg5rbAc4",
          authDomain: "regresion-lineal-48e35.firebaseapp.com",
          projectId: "regresion-lineal-48e35",
          storageBucket: "regresion-lineal-48e35.firebasestorage.app",
          messagingSenderId: "554331462950",
          appId: "1:554331462950:web:339f5145eed59fb7c475e7"
        };
        // ==================================================================

        // Inicialización
        let app, db, auth, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            signInAnonymously(auth).catch(e => console.error("Error Auth:", e));
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    setupDataListener();
                }
            });
        } catch (e) {
            document.getElementById('loadingMessage').innerText = "Error: Configura Firebase en el código.";
            console.error("Falta configuración Firebase", e);
        }

        // Variables Globales
        let allDataPoints = [];
        let regressionLine = { m: 0.2, b: 2 }; 
        const seedData = [
            { x: 4, y: 2.5, isSeed: true }, { x: 14, y: 4.0, isSeed: true },
            { x: 24, y: 7.2, isSeed: true }, { x: 38, y: 8.8, isSeed: true }, { x: 2, y: 1.0, isSeed: true }
        ];

        // Lógica de Regresión
        function calculateRegression(data) {
            if (data.length < 2) return { m: 0, b: 5 };
            const n = data.length;
            const sumX = data.reduce((s, p) => s + p.x, 0); 
            const sumY = data.reduce((s, p) => s + p.y, 0); 
            const meanX = sumX / n; const meanY = sumY / n;
            let num = 0, den = 0;
            for (const p of data) {
                const dx = p.x - meanX; const dy = p.y - meanY;
                num += dx * dy; den += dx * dx;
            }
            const m = den !== 0 ? num / den : 0;
            return { m: m, b: meanY - m * meanX };
        }

        // Canvas y Dibujo
        const canvas = document.getElementById('dataChart');
        const ctx = canvas.getContext('2d');
        const C_SIZE = 400, PAD = 40, CHART_AREA = C_SIZE - 2 * PAD;
        let drawnPoints = [], hoveredPoint = null;

        canvas.addEventListener('mousemove', (e) => {
            const r = canvas.getBoundingClientRect();
            const mx = (e.clientX - r.left) * (canvas.width / r.width);
            const my = (e.clientY - r.top) * (canvas.height / r.height);
            let found = null;
            for (let i = drawnPoints.length - 1; i >= 0; i--) {
                const p = drawnPoints[i];
                if ((mx-p.cx)**2 + (my-p.cy)**2 < 64) { found = p.data; break; }
            }
            if (found !== hoveredPoint) { hoveredPoint = found; drawChart(allDataPoints, regressionLine); }
        });
        canvas.addEventListener('mouseleave', () => { hoveredPoint = null; drawChart(allDataPoints, regressionLine); });

        function drawChart(data, line) {
            ctx.clearRect(0, 0, C_SIZE, C_SIZE);
            drawnPoints = []; const labels = [];
            const mapX = v => PAD + (v / 40) * CHART_AREA;
            const mapY = v => C_SIZE - PAD - (v / 10) * CHART_AREA;

            // Ejes
            ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 2; ctx.beginPath();
            ctx.moveTo(PAD, C_SIZE - PAD); ctx.lineTo(C_SIZE - PAD, C_SIZE - PAD);
            ctx.moveTo(PAD, C_SIZE - PAD); ctx.lineTo(PAD, PAD); ctx.stroke();

            // Texto Ejes
            ctx.fillStyle = '#4b5563'; ctx.font = '12px Inter';
            ctx.fillText('0', PAD-15, C_SIZE-PAD+15); ctx.fillText('40', C_SIZE-PAD, C_SIZE-PAD+15); ctx.fillText('10', PAD-25, PAD+5);

            // Línea Regresión
            ctx.strokeStyle = '#06b6d4'; ctx.lineWidth = 3; ctx.beginPath();
            ctx.moveTo(mapX(0), mapY(line.m * 0 + line.b));
            ctx.lineTo(mapX(40), mapY(line.m * 40 + line.b));
            ctx.stroke();

            // Puntos
            data.forEach(p => {
                const cx = mapX(p.x), cy = mapY(p.y);
                if (!isNaN(cx) && !isNaN(cy)) {
                    drawnPoints.push({cx, cy, data: p});
                    ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2);
                    ctx.fillStyle = p.isSeed ? '#a5f3fc' : '#0f766e';
                    ctx.fill(); ctx.stroke();

                    if (p.name && !p.isSeed && hoveredPoint !== p) {
                        const lbl = p.name; ctx.font = 'bold 12px Inter';
                        const w = ctx.measureText(lbl).width;
                        const rx = cx+8, ry = cy-6;
                        let overlap = labels.some(r => rx < r.x+r.w && rx+w > r.x && ry < r.y+r.h && ry+14 > r.y);
                        if (!overlap) {
                            ctx.fillStyle = '#1f2937'; ctx.fillText(lbl, rx, cy+4);
                            labels.push({x: rx, y: ry, w: w, h: 14});
                        }
                    }
                }
            });

            // Tooltip
            if (hoveredPoint) {
                const p = hoveredPoint, hx = mapX(p.x), hy = mapY(p.y);
                const txt = `${p.name||'Dato'}: ${p.x}h -> ${p.y}`;
                ctx.fillStyle = 'rgba(31,41,55,0.9)'; const w = ctx.measureText(txt).width+16;
                ctx.beginPath(); ctx.roundRect(hx+10, hy-30, w, 26, 4); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.fillText(txt, hx+18, hy-13);
                ctx.beginPath(); ctx.arc(hx, hy, 7, 0, Math.PI*2); ctx.strokeStyle = '#fff'; ctx.stroke();
            }
        }

        // Listeners
        function setupDataListener() {
            // Nombre de la colección en TU base de datos
            const q = query(collection(db, "study_success_data")); 
            onSnapshot(q, (snap) => {
                const fetched = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if (!isNaN(d.studyHours) && !isNaN(d.successScore)) 
                        fetched.push({ x: Number(d.studyHours), y: Number(d.successScore), name: d.userName, isSeed: false });
                });
                allDataPoints = [...seedData, ...fetched];
                regressionLine = calculateRegression(allDataPoints);
                const m = regressionLine.m.toFixed(2), b = regressionLine.b.toFixed(2);
                document.getElementById('lineEquation').innerText = `y = ${m}x + ${b}`;
                drawChart(allDataPoints, regressionLine);
                document.getElementById('loadingMessage').style.display = 'none';
            });
        }

        // Eventos UI
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('userName').value;
            const x = Number(document.getElementById('studyHours').value);
            const y = Number(document.getElementById('successScore').value);
            const pred = regressionLine.m * x + regressionLine.b;
            
            document.getElementById('predictionResult').innerText = `${pred.toFixed(2)} / 10`;
            document.getElementById('resultBox').classList.remove('hidden');

            try {
                await addDoc(collection(db, "study_success_data"), {
                    studyHours: x, successScore: y, userName: name, timestamp: serverTimestamp()
                });
            } catch (err) { console.error("Error guardando:", err); alert("Error guardando datos. Revisa la consola."); }
        });

        document.getElementById('predictBtn').addEventListener('click', () => {
            const x = Number(document.getElementById('predictHours').value);
            const val = Math.max(0, Math.min(10, regressionLine.m * x + regressionLine.b));
            document.getElementById('predictionText').innerText = `${val.toFixed(2)} / 10`;
        });

        drawChart(seedData, regressionLine);
    </script>
</body>
</html>
