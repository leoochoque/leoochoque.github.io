<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Multijugador (Standalone)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evitar scroll */
        }
        canvas {
            background-color: #0c0a09; /* stone-950 */
            border: 2px solid #57534e; /* stone-600 */
            border-radius: 0.5rem; /* rounded-lg */
        }
    </style>
</head>
<body class="bg-stone-900 text-stone-200 flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-3xl font-bold mb-2 text-lime-400">Snake Multijugador Online</h1>
    
    <div class="mb-2 text-center">
        <p>Tu ID de Jugador: <span id="userIdDisplay" class="font-mono bg-stone-700 px-2 py-1 rounded">Cargando...</span></p>
        <p class="text-xl">Puntuación: <span id="scoreDisplay" class="font-bold text-lime-400">0</span></p>
    </div>

    <!-- Contenedor del juego -->
    <div class="relative">
        <canvas id="gameCanvas" width="500" height="500"></canvas>
        
        <!-- Mensaje de Game Over -->
        <div id="gameOver" class="hidden absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center rounded-lg">
            <h2 class="text-4xl font-bold text-red-500 mb-4">¡Has Perdido!</h2>
            <button id="playAgain" class="bg-lime-500 hover:bg-lime-600 text-stone-900 font-bold py-2 px-6 rounded-lg text-xl transition-colors">
                Jugar de Nuevo
            </button>
        </div>
    </div>
    
    <p class="mt-4 text-sm text-stone-400">Usa las teclas de flecha para moverte.</p>

    <!-- SDK de Firebase -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            collection,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        // ¡¡¡ IMPORTANTE !!!
        // 1. Ve a https://firebase.google.com/ y crea un nuevo proyecto.
        // 2. En tu proyecto, ve a "Configuración del proyecto" (Project Settings).
        // 3. Haz clic en el ícono web (</>) para "Añadir una app web".
        // 4. Firebase te dará un objeto `firebaseConfig`. Cópialo y pégalo aquí.
        
        const firebaseConfig = {
            apiKey: "AIzaSyCOYxKXG6HLVX8kZmhfs78bArc8t7SjyeI",
            authDomain: "snakegame-c124c.firebaseapp.com",
            projectId: "snakegame-c124c",
            storageBucket: "snakegame-c124c.firebasestorage.app",
            messagingSenderId: "737051409398",
            appId: "1:737051409398:web:f52fe69c15b4198c7865d7",
            measurementId: "G-49SY7DMDHP"
        };

        // --- Inicialización de Firebase ---
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Habilitar logs de Firestore
            console.log("Firebase inicializado correctamente.");
        } catch (e) {
            console.error("Error al inicializar Firebase. ¿Pegaste tu firebaseConfig?", e);
            alert("Error de configuración de Firebase. Revisa la consola para más detalles.");
        }


        // --- Constantes del Juego ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GRID_SIZE = 25; // 25x25 celdas
        const CELL_SIZE = canvas.width / GRID_SIZE; // 500 / 25 = 20px
        const GAME_SPEED_MS = 150; // Velocidad del juego (ms por tick)

        // --- Elementos del DOM ---
        const scoreDisplay = document.getElementById('scoreDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const gameOverDisplay = document.getElementById('gameOver');
        const playAgainButton = document.getElementById('playAgain');

        // --- Estado del Juego (Local) ---
        let myUserId = null;
        let players = {}; 
        let food = {}; 
        let myDirection = 'right'; 
        let nextDirection = 'right'; 
        let gameInterval = null;
        let isGameOver = false;
        let unsubscribePlayers = null; 
        let unsubscribeFood = null; 

        // --- Referencias de Firestore (Rutas Simplificadas) ---
        // Estas son colecciones/documentos en la raíz de tu base de datos.
        const playersCollectionRef = collection(db, "snake_players");
        const foodDocRef = doc(db, "snake_game", "food");
        
        // --- Autenticación ---
        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Usuario autenticado:", user.uid);
                    myUserId = user.uid;
                    userIdDisplay.textContent = myUserId;
                    // Iniciar el juego una vez autenticado
                    initGame();
                } else {
                    console.log("Usuario no autenticado, iniciando sesión anónima...");
                    // 2. Habilita "Autenticación Anónima" en la pestaña 
                    //    Authentication -> Sign-in method de tu proyecto de Firebase.
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error al iniciar sesión anónima:", error);
                        alert("Error de autenticación. Asegúrate de habilitar 'Inicio de sesión anónimo' en tu proyecto de Firebase.");
                    }
                }
            });
        }

        // --- Inicialización del Juego ---
        async function initGame() {
            console.log("Iniciando juego...");
            if (!myUserId) {
                console.error("No hay ID de usuario, no se puede iniciar el juego.");
                return;
            }

            // Limpiar estado anterior
            if (gameInterval) clearInterval(gameInterval);
            isGameOver = false;
            gameOverDisplay.classList.add('hidden');
            
            myDirection = 'right';
            nextDirection = 'right';
            
            const startX = Math.floor(Math.random() * GRID_SIZE);
            const startY = Math.floor(Math.random() * GRID_SIZE);
            const myInitialSnake = [{ x: startX, y: startY }];
            const myColor = `hsl(${Math.random() * 360}, 100%, 75%)`;

            // Crear/actualizar mi documento de jugador en Firestore
            // 3. Habilita "Firestore" en tu proyecto de Firebase.
            //    Al crearlo, elige "Modo de Prueba" (Test Mode) para empezar.
            //    Esto permite leer/escribir durante 30 días.
            //    REGLAS DE SEGURIDAD (para modo de prueba):
            //    rules_version = '2';
            //    service cloud.firestore {
            //      match /databases/{database}/documents {
            //        match /{document=**} {
            //          allow read, write: if request.time < timestamp.date(2025, 12, 14); // Cambia la fecha
            //        }
            //      }
            //    }
            const myPlayerDocRef = doc(playersCollectionRef, myUserId);
            try {
                await setDoc(myPlayerDocRef, {
                    snake: myInitialSnake,
                    score: 0,
                    color: myColor,
                    lastSeen: serverTimestamp()
                });
                console.log("Documento de jugador creado/actualizado.");
            } catch (e) {
                console.error("Error al crear documento de jugador. ¿Habilitaste Firestore y configuraste las Reglas de Seguridad?", e);
                alert("Error de base de datos. Asegúrate de que Firestore esté habilitado y tus reglas de seguridad permitan la escritura.");
                return;
            }

            // Iniciar listeners de Firestore
            startListeners();

            setTimeout(async () => {
                if (!food.x) {
                    console.log("No hay comida, creando una nueva.");
                    await placeFood();
                }
            }, 500);

            gameInterval = setInterval(gameLoop, GAME_SPEED_MS);
            requestAnimationFrame(renderLoop);
        }

        // --- Listeners de Firestore ---
        function startListeners() {
            if (unsubscribePlayers) unsubscribePlayers();
            if (unsubscribeFood) unsubscribeFood();

            // Listener para la colección de jugadores
            unsubscribePlayers = onSnapshot(playersCollectionRef, (snapshot) => {
                const newPlayers = {};
                snapshot.forEach((doc) => {
                    newPlayers[doc.id] = doc.data();
                });
                players = newPlayers;
                
                if (players[myUserId]) {
                    scoreDisplay.textContent = players[myUserId].score;
                } else if (!isGameOver) {
                    console.log("Mi jugador ya no existe en Firestore. Terminando juego.");
                    handleGameOver(false); 
                }
            });

            // Listener para el documento de comida
            unsubscribeFood = onSnapshot(foodDocRef, (doc) => {
                if (doc.exists()) {
                    food = doc.data();
                } else {
                    console.log("Documento de comida no existe. Intentando crear...");
                    placeFood().catch(e => console.warn("Carrera al crear comida, ignorando."));
                }
            });
        }

        // --- Colocar Comida ---
        async function placeFood() {
            let newFoodPos = { x: 0, y: 0 };
            let onSnake = true;

            while (onSnake) {
                newFoodPos = {
                    x: Math.floor(Math.random() * GRID_SIZE),
                    y: Math.floor(Math.random() * GRID_SIZE)
                };
                onSnake = false; 
                
                for (const playerId in players) {
                    if (players[playerId].snake.some(segment => segment.x === newFoodPos.x && segment.y === newFoodPos.y)) {
                        onSnake = true; 
                        break;
                    }
                }
            }
            
            try {
                await setDoc(foodDocRef, newFoodPos);
                console.log("Nueva comida colocada en:", newFoodPos);
            } catch (e) {
                console.error("Error al colocar comida:", e);
            }
        }

        // --- Bucle Principal del Juego (Lógica) ---
        async function gameLoop() {
            if (isGameOver || !myUserId || !players[myUserId]) {
                return;
            }

            let myPlayer = players[myUserId];
            let localSnake = [...myPlayer.snake];
            let localScore = myPlayer.score;
            
            myDirection = nextDirection;

            let head = { ...localSnake[0] }; 
            if (myDirection === 'right') head.x++;
            if (myDirection === 'left') head.x--;
            if (myDirection === 'up') head.y--;
            if (myDirection === 'down') head.y++;

            // --- Detección de Colisiones ---
            if (head.x < 0 || head.x >= GRID_SIZE || head.y < 0 || head.y >= GRID_SIZE) {
                console.log("Colisión con pared");
                handleGameOver();
                return;
            }
            if (localSnake.some(segment => segment.x === head.x && segment.y === head.y)) {
                console.log("Colisión consigo mismo");
                handleGameOver();
                return;
            }
            for (const playerId in players) {
                if (playerId === myUserId) continue; 
                const otherSnake = players[playerId].snake;
                if (otherSnake.some(segment => segment.x === head.x && segment.y === head.y)) {
                    console.log(`Colisión con jugador ${playerId}`);
                    handleGameOver();
                    return;
                }
            }

            localSnake.unshift(head); 

            if (head.x === food.x && head.y === food.y) {
                localScore++; 
                placeFood(); 
            } else {
                localSnake.pop(); 
            }

            // --- Actualizar Firestore ---
            try {
                const myPlayerDocRef = doc(playersCollectionRef, myUserId);
                await setDoc(myPlayerDocRef, { 
                    ...myPlayer, 
                    snake: localSnake, 
                    score: localScore,
                    lastSeen: serverTimestamp()
                }, { merge: true }); 
            } catch (e) {
                console.error("Error al actualizar estado del jugador:", e);
            }
        }

        // --- Bucle de Renderizado (Dibujo) ---
        function renderLoop() {
            if (isGameOver) {
                return; 
            }

            ctx.fillStyle = '#0c0a09'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (food.x !== undefined) {
                ctx.fillStyle = '#60a5fa'; 
                ctx.fillRect(food.x * CELL_SIZE, food.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                ctx.strokeStyle = '#3b82f6'; 
                ctx.strokeRect(food.x * CELL_SIZE, food.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            }

            for (const playerId in players) {
                const player = players[playerId];
                const snake = player.snake;
                const color = player.color || '#a3e635';

                snake.forEach((segment, index) => {
                    ctx.fillStyle = (index === 0) ? lightenColor(color, 25) : color; 
                    ctx.fillRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    ctx.strokeStyle = darkenColor(color, 25);
                    ctx.strokeRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                });
            }

            requestAnimationFrame(renderLoop);
        }

        // --- Manejo de Game Over ---
        async function handleGameOver(deleteMyDoc = true) {
            console.log("¡Juego terminado!");
            isGameOver = true;
            clearInterval(gameInterval);
            gameOverDisplay.classList.remove('hidden');

            if (unsubscribePlayers) {
                unsubscribePlayers();
                unsubscribePlayers = null;
            }
            if (unsubscribeFood) {
                unsubscribeFood();
                unsubscribeFood = null;
            }

            if (deleteMyDoc && myUserId) {
                try {
                    await deleteDoc(doc(playersCollectionRef, myUserId));
                    console.log("Documento de jugador eliminado.");
                } catch (e) {
                    console.error("Error al eliminar documento de jugador:", e);
                }
            }
        }

        // --- Control de Teclado ---
        document.addEventListener('keydown', e => {
            switch (e.key) {
                case 'ArrowUp':
                    if (myDirection !== 'down') nextDirection = 'up';
                    break;
                case 'ArrowDown':
                    if (myDirection !== 'up') nextDirection = 'down';
                    break;
                case 'ArrowLeft':
                    if (myDirection !== 'right') nextDirection = 'left';
                    break;
                case 'ArrowRight':
                    if (myDirection !== 'left') nextDirection = 'right';
                    break;
            }
        });

        // --- Botón de Jugar de Nuevo ---
        playAgainButton.addEventListener('click', () => {
            console.log("Botón 'Jugar de Nuevo' presionado.");
            initGame();
        });

        // --- Funciones de Utilidad (Color) ---
        function lightenColor(hsl, percent) {
            const [h, s, l] = hsl.match(/\d+/g).map(Number);
            const newL = Math.min(100, l + percent);
            return `hsl(${h}, ${s}%, ${newL}%)`;
        }

        function darkenColor(hsl, percent) {
            const [h, s, l] = hsl.match(/\d+/g).map(Number);
            const newL = Math.max(0, l - percent);
            return `hsl(${h}, ${s}%, ${newL}%)`;
        }
        
        // --- Iniciar la autenticación al cargar la página ---
        window.addEventListener('load', () => {
            if (firebaseConfig.apiKey === "TU_API_KEY_AQUI") {
                alert("Error: Debes editar el archivo snake_standalone.html y añadir tu configuración de Firebase (firebaseConfig) para que el juego funcione.");
                console.error("Configuración de Firebase no encontrada.");
            } else {
                setupAuth();
            }
        });

    </script>
</body>
</html>
